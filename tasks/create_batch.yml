---
# Create one batch of nodes based on current Satellite state

- name: Batch {{ batch_index }} | Get existing node names from Satellite
  command: hammer host list --search "name ~ {{ node_prefix }}" --fields name --per-page 1000
  register: hammer_output

- name: Batch {{ batch_index }} | Extract used node numbers
  set_fact:
    used_nodes: "{{ hammer_output.stdout | regex_findall(node_prefix ~ '(\\d{3})') | map('int') | list }}"

- name: Batch {{ batch_index }} | Determine next {{ batch_size }} available node names
  set_fact:
    batch_nodes: >-
      {{
        range(start_number, max_node_number + 1)
        | reject('in', used_nodes)
        | map('int')
        | map('regex_replace', '^(\\d{1,3})$', lambda x: '%03d' | format(x | int))
        | map('regex_replace', '^', node_prefix)
        | list
        | slice(batch_size)
      }}

- name: Batch {{ batch_index }} | Assert we have nodes to create
  assert:
    that:
      - batch_nodes | length > 0
    fail_msg: "No available node numbers remaining up to {{ max_node_number }}."
    success_msg: "Will create these nodes: {{ batch_nodes }}"

- name: Batch {{ batch_index }} | Create nodes
  include_tasks: create_node.yml
  loop: "{{ batch_nodes }}"
  loop_control:
    loop_var: node_name
    label: "{{ node_name }}"

- name: Batch {{ batch_index }} | Pause before next batch
  pause:
    seconds: "{{ delay_between_batches }}"
  when: not ansible_loop.last
