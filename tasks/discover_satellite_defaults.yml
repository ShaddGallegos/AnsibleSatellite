---
# Discover key Satellite values using hammer and set them only if not already provided
# Assumes this runs on localhost where hammer is configured

- name: Ensure hammer is available
  command: hammer --version
  register: _hammer_version
  changed_when: false
  failed_when: _hammer_version.rc != 0

- name: Discover organization list
  command: hammer --output json organization list
  register: _org_list
  changed_when: false
  failed_when: false

- name: Set organization from Satellite when missing
  set_fact:
    org: >-
      {{ (
          (_org_list.stdout | from_json) | map(attribute='Name')
          | select('search', org)
          | list | first
        )
        | default(((_org_list.stdout | from_json) | map(attribute='Name') | list | first) | default(org | default(''))) }}
  when: (org | default('')) | length == 0 or (org | length > 0 and ((_org_list.stdout | from_json) | map(attribute='Name') | select('eq', org) | list | length) == 0)

- name: Discover location list
  command: hammer --output json location list
  register: _loc_list
  changed_when: false
  failed_when: false

- name: Set location from Satellite when missing
  set_fact:
    location: >-
      {{ (
          (_loc_list.stdout | from_json) | map(attribute='Name')
          | select('search', location)
          | list | first
        )
        | default(((_loc_list.stdout | from_json) | map(attribute='Name') | list | first) | default(location | default(''))) }}
  when: (location | default('')) | length == 0 or (location | length > 0 and ((_loc_list.stdout | from_json) | map(attribute='Name') | select('eq', location) | list | length) == 0)

- name: Discover hostgroups
  command: hammer --output json hostgroup list
  register: _hg_list
  changed_when: false
  failed_when: false

- name: Set hostgroup from Satellite when missing
  set_fact:
    hostgroup: >-
      {{ (
          (_hg_list.stdout | from_json) | map(attribute='Title')
          | select('search', hostgroup)
          | list | first
        )
        | default(((_hg_list.stdout | from_json) | map(attribute='Title') | list | first) | default(hostgroup | default(''))) }}
  when: (hostgroup | default('')) | length == 0

- name: Discover compute resources
  command: hammer --output json compute-resource list
  register: _cr_list
  changed_when: false
  failed_when: false

- name: Set compute resource from Satellite when missing
  set_fact:
    compute_resource: >-
      {{ (
          (_cr_list.stdout | from_json) | map(attribute='Name')
          | select('search', compute_resource)
          | list | first
        )
        | default(((_cr_list.stdout | from_json) | map(attribute='Name') | list | first) | default(compute_resource | default(''))) }}
  when: (compute_resource | default('')) | length == 0 or (compute_resource | length > 0 and ((_cr_list.stdout | from_json) | map(attribute='Name') | select('eq', compute_resource) | list | length) == 0)

- name: Discover compute profiles
  command: hammer --output json compute-profile list
  register: _cp_list
  changed_when: false
  failed_when: false

- name: Set compute profile from Satellite when missing
  set_fact:
    compute_profile: >-
      {{ (
          (_cp_list.stdout | from_json) | map(attribute='Name')
          | select('search', compute_profile)
          | list | first
        )
        | default(((_cp_list.stdout | from_json) | map(attribute='Name') | list | first) | default(compute_profile | default(''))) }}
  when: (compute_profile | default('')) | length == 0 or (compute_profile | length > 0 and ((_cp_list.stdout | from_json) | map(attribute='Name') | select('eq', compute_profile) | list | length) == 0)

- name: Discover domains
  command: hammer --output json domain list
  register: _dom_list
  changed_when: false
  failed_when: false

- name: Set domain from Satellite when missing
  set_fact:
    domain: >-
      {{ (
          (_dom_list.stdout | from_json) | map(attribute='Name')
          | select('search', domain)
          | list | first
        )
        | default(((_dom_list.stdout | from_json) | map(attribute='Name') | list | first) | default(domain | default(''))) }}
  when: (domain | default('')) | length == 0 or (domain | length > 0 and ((_dom_list.stdout | from_json) | map(attribute='Name') | select('eq', domain) | list | length) == 0)

- name: Discover subnets
  command: hammer --output json subnet list
  register: _subnet_list
  changed_when: false
  failed_when: false

- name: Set subnet from Satellite when missing
  set_fact:
    subnet: >-
      {{ (
          (_subnet_list.stdout | from_json) | map(attribute='Name')
          | select('search', subnet)
          | list | first
        )
        | default(((_subnet_list.stdout | from_json) | map(attribute='Name') | list | first) | default(subnet | default(''))) }}
  when: (subnet | default('')) | length == 0 or (subnet | length > 0 and ((_subnet_list.stdout | from_json) | map(attribute='Name') | select('eq', subnet) | list | length) == 0)

- name: Discover architectures
  command: hammer --output json architecture list
  register: _arch_list
  changed_when: false
  failed_when: false

- name: Set architecture from Satellite when missing
  set_fact:
    architecture: >-
      {{ (
          (_arch_list.stdout | from_json) | map(attribute='Name')
          | select('search', architecture)
          | list | first
        )
        | default(((_arch_list.stdout | from_json) | map(attribute='Name') | list | first) | default(architecture | default(''))) }}
  when: (architecture | default('')) | length == 0 or (architecture | length > 0 and ((_arch_list.stdout | from_json) | map(attribute='Name') | select('eq', architecture) | list | length) == 0)

- name: Discover operating systems
  command: hammer --output json os list
  register: _os_list
  changed_when: false
  failed_when: false

- name: Set OS from Satellite when missing
  set_fact:
    os: >-
      {{ (
          (_os_list.stdout | from_json) | map(attribute='Title')
          | select('search', os)
          | list | first
        )
        | default(((_os_list.stdout | from_json) | map(attribute='Title') | list | first) | default(os | default(''))) }}
  when: (os | default('')) | length == 0 or (os | length > 0 and ((_os_list.stdout | from_json) | map(attribute='Title') | select('eq', os) | list | length) == 0)

- name: Discover media
  command: hammer --output json medium list
  register: _medium_list
  changed_when: false
  failed_when: false

- name: Set medium from Satellite when missing
  set_fact:
    medium: >-
      {{ (
          (_medium_list.stdout | from_json) | map(attribute='Name')
          | select('search', medium)
          | list | first
        )
        | default(((_medium_list.stdout | from_json) | map(attribute='Name') | list | first) | default(medium | default(''))) }}
  when: (medium | default('')) | length == 0 or (medium | length > 0 and ((_medium_list.stdout | from_json) | map(attribute='Name') | select('eq', medium) | list | length) == 0)

# PXE loader discovery is non-trivial via hammer; preserve current value or default
- name: Confirm PXE loader value in use
  debug:
    msg: "Using PXE loader: {{ pxe_loader }}"
