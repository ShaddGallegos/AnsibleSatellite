---
- name: Configure AAP Controller Job Template with Survey for batch node builds
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Controller connection (set via extra-vars or controller_vars.yml)
    controller_host: "https://aap-controller.example.com"
    controller_oauthtoken: ""
    controller_verify_ssl: true

    # Resource names in Controller
    organization_name: "Default"
    project_name: "AnsibleLaunchPad"
    inventory_name: "Default Inventory"
    credential_name: ""
    execution_environment: ""

    # Job Template settings
    job_template_name: "Build Nodes in Batches"
    job_description: "Create nodes in batches of 5 using the Compute hostgroup"
    job_playbook_path: "AnsibleSatellite/build_nodes_in_batches.yml"

  tasks:
    - name: Normalize Controller auth inputs (token or username/password or env)
      set_fact:
        _controller_token: "{{ (controller_oauthtoken | default(lookup('env','CONTROLLER_OAUTH_TOKEN'), true)) | default('', true) }}"
        _controller_username: "{{ (controller_username | default(lookup('env','CONTROLLER_USERNAME'), true)) | default('', true) }}"
        _controller_password: "{{ (controller_password | default(lookup('env','CONTROLLER_PASSWORD'), true)) | default('', true) }}"

    - name: Prompt for Controller username if not provided and no token
      ansible.builtin.pause:
        prompt: "Controller username (leave blank to abort)"
      register: _prompt_username
      when: _controller_token | length == 0 and _controller_username | length == 0

    - name: Prompt for Controller password when username was prompted
      ansible.builtin.pause:
        prompt: "Controller password"
        echo: no
      register: _prompt_password
      when: _controller_token | length == 0 and _controller_username | length == 0

    - name: Apply prompted credentials
      set_fact:
        _controller_username: "{{ _prompt_username.user_input | default(_controller_username) }}"
        _controller_password: "{{ _prompt_password.user_input | default(_controller_password) }}"
      when: _controller_token | length == 0 and _controller_username | length == 0

    - name: Validate we have a usable auth method (token or username/password)
      assert:
        that:
          - _controller_token | length > 0 or (_controller_username | length > 0 and _controller_password | length > 0)
        fail_msg: >-
          Missing or invalid Controller credentials. Provide controller_oauthtoken
          (or env CONTROLLER_OAUTH_TOKEN) OR controller_username/controller_password
          (or env CONTROLLER_USERNAME/CONTROLLER_PASSWORD).
    - name: Preflight | Reach Controller API (optional)
      ansible.builtin.uri:
        url: "{{ controller_host }}/api/controller/v2/ping/"
        method: GET
        return_content: false
        status_code: 200
        validate_certs: "{{ controller_verify_ssl }}"
        headers: "{{ ({'Authorization': 'Bearer ' ~ _controller_token}) if (_controller_token | length > 0) else omit }}"
        url_username: "{{ _controller_username if (_controller_token | length == 0 and _controller_username | length > 0) else omit }}"
        url_password: "{{ _controller_password if (_controller_token | length == 0 and _controller_password | length > 0) else omit }}"
        force_basic_auth: "{{ 'yes' if (_controller_token | length == 0 and _controller_username | length > 0) else omit }}"
      register: controller_ping
      ignore_errors: true

    - name: Preflight | Warn if Controller API is unreachable
      ansible.builtin.debug:
        msg: >-
          Warning: Could not reach {{ controller_host }} API (SSL/DNS?).
          Set controller_verify_ssl: false or ensure CA trust; proceeding to try module anyway.
      when: controller_ping is failed
    - name: Validate required vars are set
      assert:
        that:
          - controller_host | length > 0
          - controller_oauthtoken | length > 0
          - project_name | length > 0
          - inventory_name | length > 0
          - job_playbook_path | length > 0
        fail_msg: >-
          Missing required controller vars. Set controller_host, controller_oauthtoken,
          project_name, inventory_name, and job_playbook_path via -e or a vars file.

    - name: Build Survey spec for iterations and knobs
      set_fact:
        survey_spec:
          name: "Build Nodes in Batches Survey"
          description: "Decide how many 5-node batches to build and pacing/naming"
          spec:
            - question_name: "How many batches? (each batch builds 5 nodes)"
              required: true
              type: "integer"
              variable: "iterations"
              min: 1
              max: 100
              default: 1
              new_question: true
            - question_name: "Node prefix (e.g., 'node')"
              required: true
              type: "text"
              variable: "node_prefix"
              default: "node"
              new_question: true
            - question_name: "Delay between node creations (seconds)"
              required: true
              type: "integer"
              variable: "delay_seconds"
              min: 0
              max: 3600
              default: 30
              new_question: true
            - question_name: "Delay between batches (seconds)"
              required: true
              type: "integer"
              variable: "delay_between_batches"
              min: 0
              max: 7200
              default: 60
              new_question: true

    - block:
        - name: Ensure Job Template exists (initial creation)
          ansible.controller.job_template:
            controller_host: "{{ controller_host }}"
            controller_oauthtoken: "{{ _controller_token if _controller_token | length > 0 else omit }}"
            controller_username: "{{ _controller_username if (_controller_token | length == 0 and _controller_username | length > 0) else omit }}"
            controller_password: "{{ _controller_password if (_controller_token | length == 0 and _controller_password | length > 0) else omit }}"
            validate_certs: "{{ controller_verify_ssl }}"
            name: "{{ job_template_name }}"
            description: "{{ job_description }}"
            organization: "{{ organization_name }}"
            project: "{{ project_name }}"
            inventory: "{{ inventory_name }}"
            playbook: "{{ job_playbook_path }}"
            job_type: run
            credentials: "{{ [credential_name] if credential_name | length > 0 else omit }}"
            execution_environment: "{{ execution_environment if execution_environment | length > 0 else omit }}"
            survey_enabled: false
            state: present
      rescue:
        - name: Auth failure help
          ansible.builtin.debug:
            msg: >-
              Authentication failed for {{ controller_host }}. Ensure either
              a valid token (controller_oauthtoken or CONTROLLER_OAUTH_TOKEN) is set,
              or provide controller_username/controller_password. If using SSO,
              generate a Personal Access Token in the Controller UI.
        - name: Fail explicitly after auth hint
          ansible.builtin.fail:
            msg: "Controller authentication failed (HTTP 401)."

    - name: Ensure Job Template survey is configured
      ansible.controller.job_template:
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ _controller_token if _controller_token | length > 0 else omit }}"
        controller_username: "{{ _controller_username if (_controller_token | length == 0 and _controller_username | length > 0) else omit }}"
        controller_password: "{{ _controller_password if (_controller_token | length == 0 and _controller_password | length > 0) else omit }}"
        validate_certs: "{{ controller_verify_ssl }}"
        name: "{{ job_template_name }}"
        description: "{{ job_description }}"
        organization: "{{ organization_name }}"
        project: "{{ project_name }}"
        inventory: "{{ inventory_name }}"
        playbook: "{{ job_playbook_path }}"
        job_type: run
        survey_enabled: true
        survey_spec: "{{ survey_spec }}"
        credentials: "{{ [credential_name] if credential_name | length > 0 else omit }}"
        execution_environment: "{{ execution_environment if execution_environment | length > 0 else omit }}"
        state: present
