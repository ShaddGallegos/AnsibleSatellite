---
# Create or update AAP (AWX/Controller) credentials for secrets referenced in repository
# Synopsis: Ensures a unified set of credentials (Satellite API, Admin user, KVM access, SMTP/Gmail, Controller OAuth) exist
# Defaults any missing secret to r3dh4t7! per repository policy. Avoids duplication by idempotent creation.
# Requirements: awx.awx collection installed on execution environment.
# Usage examples:
#   ansible-playbook create_aap_credentials.yml -e controller_host=https://aap.example.com -e controller_username=admin -e controller_password=r3dh4t7! -e organization_name="Default"
#   ansible-playbook create_aap_credentials.yml -e controller_host=https://aap.example.com -e controller_oauthtoken=XXXX -e organization_name="Default"
# Variables:
#   controller_host            (URL to Controller/AWX)
#   controller_username        (If not using OAuth token)
#   controller_password        (If not using OAuth token)
#   controller_oauthtoken      (Alternative to username/password)
#   organization_name          (Target organization; default 'Default')
#   satellite_api_user         (Default 'admin')
#   satellite_api_password     (Secret; default r3dh4t7!)
#   admin_user_password        (Generic admin user password; default r3dh4t7!)
#   kvm_password               (KVM/libvirt access password if needed; default r3dh4t7!)
#   gmail_smtp_username        (If using Gmail relay)
#   gmail_smtp_app_password    (App password; default r3dh4t7!)
#   controller_oauth_token     (Alias for controller_oauthtoken)
#   create_missing_only        (Bool; if true tasks skip credentials that already exist by name)
#
# NOTE: Credential types must exist in the Controller installation. Standard types used:
#   - Red Hat Satellite 6
#   - Machine
#   - Source Control (for future expansion)
#   - Custom types may require prior setup; adjust 'credential_type' names if they differ.

- name: Ensure AAP credentials present
  hosts: localhost
  gather_facts: false

  vars:
    organization_name: "{{ organization_name | default('Default') }}"
    default_password: "r3dh4t7!"

    satellite_api_user: "{{ satellite_api_user | default('admin') }}"
    satellite_api_password: "{{ satellite_api_password | default(default_password) }}"
    admin_user_password: "{{ admin_user_password | default(default_password) }}"
    kvm_password: "{{ kvm_password | default(default_password) }}"
    gmail_smtp_username: "{{ gmail_smtp_username | default(omit) }}"
    gmail_smtp_app_password: "{{ gmail_smtp_app_password | default(default_password) }}"

    # Accept either controller_oauthtoken or controller_oauth_token
    controller_oauthtoken: "{{ controller_oauthtoken | default(controller_oauth_token | default(omit)) }}"

    create_missing_only: "{{ create_missing_only | default(false) | bool }}"

    credentials_def:
      - name: "Satellite API Password"
        type: "Red Hat Satellite 6"
        inputs:
          username: "{{ satellite_api_user }}"
          password: "{{ satellite_api_password }}"
      - name: "Admin User Password"
        type: "Machine"
        inputs:
          username: "admin"
          password: "{{ admin_user_password }}"
      - name: "KVM Access Password"
        type: "Machine"
        inputs:
          username: "kvm"
          password: "{{ kvm_password }}"
      - name: "Gmail SMTP App Password"
        type: "Machine"
        when_defined: gmail_smtp_username
        inputs:
          username: "{{ gmail_smtp_username | default('gmail-user') }}"
          password: "{{ gmail_smtp_app_password }}"
      - name: "Controller OAuth Token"
        type: "Source Control"
        when_defined: controller_oauthtoken
        inputs:
          token: "{{ controller_oauthtoken }}"

  tasks:
    - name: Validate controller_host provided
      ansible.builtin.fail:
        msg: "controller_host variable required (e.g. -e controller_host=https://aap.example.com)"
      when: controller_host is not defined

    - name: Set auth mode
      ansible.builtin.set_fact:
        _use_oauth: "{{ controller_oauthtoken is defined }}"

    - name: Fail if neither username/password nor oauth token provided
      ansible.builtin.fail:
        msg: "Provide controller_username/controller_password or controller_oauthtoken"
      when: not _use_oauth and (controller_username is not defined or controller_password is not defined)

    - name: Filter credentials by presence of conditional secrets
      ansible.builtin.set_fact:
        _filtered_credentials: >-
          {{ credentials_def | selectattr('when_defined','equalto',None) | list +
             (credentials_def | selectattr('when_defined','defined') | selectattr('when_defined','in',[ 'gmail_smtp_username','controller_oauthtoken' ]) | list) }}
      vars:
        # Mark entries without when_defined key as always included
        credentials_def: >-
          {{ credentials_def | map('combine', {'when_defined': (item.when_defined | default(None))}) | list }}
      # NOTE: Above transformation ensures uniform key presence

    - name: Normalize credential list (remove conditionally absent items)
      ansible.builtin.set_fact:
        _final_credentials: >-
          {{ credentials_def | rejectattr('when_defined','defined') | list +
             (controller_oauthtoken is defined | ternary(credentials_def | selectattr('name','equalto','Controller OAuth Token') | list, [])) +
             (gmail_smtp_username is defined | ternary(credentials_def | selectattr('name','equalto','Gmail SMTP App Password') | list, [])) }}

    - name: Retrieve existing credentials (names only)
      awx.awx.export:
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: false
        assets:
          - credentials
      register: _existing_creds

    - name: Build existing credential name list
      ansible.builtin.set_fact:
        _existing_names: "{{ _existing_creds.assets.credentials | map(attribute='name') | list | default([]) }}"

    - name: Create or update credentials
      awx.awx.credential:
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: false
        name: "{{ item.name }}"
        organization: "{{ organization_name }}"
        credential_type: "{{ item.type }}"
        inputs: "{{ item.inputs }}"
        state: present
      loop: "{{ _final_credentials }}"
      when: not create_missing_only or (item.name not in _existing_names)
      register: _cred_results

    - name: Report credential operations
      ansible.builtin.debug:
        msg: >-
          {{ _cred_results.results | map(attribute='name') | list | length }} credentials processed. Created or updated: {{ _cred_results.results | map(attribute='name') | list }}

    - name: Guidance for inventory variable usage
      ansible.builtin.debug:
        msg: |
          Use created credentials in Job Templates referencing:
          - Satellite API Password (for template, host operations)
          - Admin User Password (post-install tasks)
          - KVM Access Password (libvirt tasks)
          - Gmail SMTP App Password (email configuration) if defined
          - Controller OAuth Token (Controller API interactions)

      when: _cred_results is defined
