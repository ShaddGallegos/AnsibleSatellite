---
# Create enhanced Kickstart post template on Satellite (clean)
# Synopsis: Generates improved RHEL 9.7 post-kickstart template in-place on Satellite by copying base header, injecting advanced %post logic, aggregating public SSH keys, and preserving security.
- name: Create enhanced Kickstart post template on Satellite (clean)
  hosts: "{{ sat_host | default('satellite.prod.spg') }}"
  become: true
  gather_facts: false
  vars:
    sat_existing_template_path: "/usr/share/foreman/app/views/unattended/provisioning_templates/provision/RHEL_9.7_x86_64_kickstart_default.erb"
    sat_new_template_path: "/usr/share/foreman/app/views/unattended/provisioning_templates/provision/RHEL_9.7_x86_64_kickstart_post_default.erb"
    admin_user: "{{ admin_user | default('admin') }}"
    admin_password: "{{ admin_password | default('r3dh4t7!') }}"
    force_password_change: "{{ force_password_change | default(true) }}"
    activation_keys: "{{ activation_keys | default('9:RHEL9-AK') }}"
    ks_enable_updates: "{{ ks_enable_updates | default(false) }}"
    ks_firewall_services: "{{ ks_firewall_services | default('ssh,http,https') }}"
    satellite_ip: "{{ satellite_ip | default('10.168.151.127') }}"
    satellite_fqdn: "{{ satellite_fqdn | default('satellite.prod.spg') }}"
    ssh_key_source_dirs:
      - /var/lib/foreman/.ssh
      - /root/.ssh
      - "/home/{{ admin_user }}/.ssh"
  tasks:
    - name: Stat base template
      stat:
        path: "{{ sat_existing_template_path }}"
      register: base_stat
    - name: Abort if base template missing
      fail:
        msg: "Base template not found at {{ sat_existing_template_path }}"
      when: not base_stat.stat.exists
    - name: Slurp base template
      slurp:
        path: "{{ sat_existing_template_path }}"
      register: base_raw
    - name: Decode base template
      set_fact:
        base_template_content: "{{ base_raw.content | b64decode }}"
    - name: Collect SSH key directory stats
      stat:
        path: "{{ item }}"
      loop: "{{ ssh_key_source_dirs }}"
      register: key_dirs
      failed_when: false
    - name: Derive missing public keys
      shell: |
        set -e
        d="{{ item.path }}"; [ -d "$d" ] || exit 0
        if [ -f "$d/id_rsa" ] && [ ! -f "$d/id_rsa.pub" ]; then ssh-keygen -y -f "$d/id_rsa" > "$d/id_rsa.pub"; fi
      args:
        executable: /bin/bash
      loop: "{{ key_dirs.results }}"
      changed_when: false
      failed_when: false
    - name: Find .pub files
      find:
        paths: "{{ item.path }}"
        patterns: "*.pub"
        file_type: file
      loop: "{{ key_dirs.results }}"
      register: pub_files
      failed_when: false
    - name: Slurp public keys
      slurp:
        path: "{{ item.path }}"
      loop: "{{ pub_files.results | map(attribute='files') | flatten | default([]) }}"
      register: pub_contents
      failed_when: false
    - name: Aggregate unique public keys
      set_fact:
        all_public_keys: "{{ pub_contents.results | map(attribute='content') | map('b64decode') | list | unique }}"
    - name: Build %post section
      set_fact:
        post_section: "{{ lookup('template','node_provisioning/templates/kickstart_post_section.j2') }}"
    - name: Stat new template
      stat:
        path: "{{ sat_new_template_path }}"
      register: new_stat
    - name: Backup existing new template
      copy:
        src: "{{ sat_new_template_path }}"
        dest: "{{ sat_new_template_path }}.bak_{{ ansible_date_time.iso8601_basic }}"
        remote_src: true
      when: new_stat.stat.exists
    - name: Assemble new template content
      set_fact:
        new_template_content: "{{ base_template_content.split('%post')[0] | trim }}\n{{ post_section }}"
    - name: Write new template file
      copy:
        content: "{{ new_template_content }}"
        dest: "{{ sat_new_template_path }}"
        owner: root
        group: root
        mode: '0644'
    - name: Summary
      debug:
        msg: |
          Template: {{ sat_new_template_path }}
          Keys included: {{ all_public_keys | length }}
          Admin user: {{ admin_user }}
          Activation keys: {{ activation_keys }}
          Updates enabled: {{ ks_enable_updates }}
          Backup existed: {{ new_stat.stat.exists | ternary('yes','no') }}
