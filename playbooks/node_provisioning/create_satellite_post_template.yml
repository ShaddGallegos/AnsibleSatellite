---
### Playbook: create_satellite_post_template.yml
# Consolidated fixed version.
# Issues fixed:
#  - Removed duplicate second play (previous file contained two plays).
#  - Enabled fact gathering OR provided timestamp without relying on ansible_date_time when gather_facts was false.
#  - Replaced ansible_date_time usage with a portable timestamp command.
#  - Simplified public key collection logic (single pass with derivation + re-scan).
#  - Cleaned up heredoc / password hashing section for reliability.
#  - Added explicit satellite_ip / satellite_fqdn variables to avoid hostvars indirection.
#  - Ensured backup operation does not fail when facts are disabled.

- name: Create enhanced Kickstart post template on Satellite
  hosts: "{{ sat_host | default('satellite.prod.spg') }}"
  become: true
  gather_facts: true

  vars:
    sat_existing_template_path: "/usr/share/foreman/app/views/unattended/provisioning_templates/provision/RHEL_9.7_x86_64_kickstart_default.erb"
    sat_new_template_path: "/usr/share/foreman/app/views/unattended/provisioning_templates/provision/RHEL_9.7_x86_64_kickstart_post_default.erb"
    admin_user: "{{ admin_user | default('admin') }}"
    admin_password: "{{ admin_password | default('r3dh4t7!') }}"
    force_password_change: "{{ force_password_change | default(true) }}"
    activation_keys: "{{ activation_keys | default('9:RHEL9-AK') }}"
    ks_enable_updates: "{{ ks_enable_updates | default(false) }}"
    ks_firewall_services: "{{ ks_firewall_services | default('ssh,http,https') }}"
    satellite_ip: "{{ satellite_ip | default('10.168.151.127') }}"
    satellite_fqdn: "{{ satellite_fqdn | default('satellite.prod.spg') }}"
    ssh_key_source_dirs:
      - /var/lib/foreman/.ssh
      - /root/.ssh
      - "/home/{{ admin_user }}/.ssh"
    _timestamp: "{{ lookup('pipe','date +%Y%m%d%H%M%S') }}"

  tasks:
    - name: Verify existing base template path
      ansible.builtin.stat:
        path: "{{ sat_existing_template_path }}"
      register: _base_template_stat

    - name: Fail if base template missing
      ansible.builtin.fail:
        msg: "Base template not found at {{ sat_existing_template_path }}"
      when: not _base_template_stat.stat.exists

    - name: Read base kickstart template
      ansible.builtin.slurp:
        path: "{{ sat_existing_template_path }}"
      register: _base_template_raw

    - name: Decode base template content
      ansible.builtin.set_fact:
        _base_template_content: "{{ _base_template_raw.content | b64decode }}"

    - name: Collect SSH key directory stats
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ ssh_key_source_dirs }}"
      register: _key_dirs
      failed_when: false

    - name: Derive and collect public keys (single pass)
      ansible.builtin.shell: |
        set -e
        d="{{ item.path }}"
        [ -d "$d" ] || exit 0
        priv="$d/id_rsa"
        pub="$d/id_rsa.pub"
        if [ -f "$priv" ] && [ ! -f "$pub" ]; then
          ssh-keygen -y -f "$priv" > "$pub" || true
        fi
        find "$d" -maxdepth 1 -type f -name '*.pub' -exec cat {} + 2>/dev/null || true
      args:
        executable: /bin/bash
      loop: "{{ _key_dirs.results }}"
      register: _pub_cat
      changed_when: false
      failed_when: false

    - name: Build unique public key list
      ansible.builtin.set_fact:
        _all_public_keys: "{{ _pub_cat.results | map(attribute='stdout') | join('\n') | split('\n') | map('trim') | reject('equalto','') | list | unique }}"

    - name: Prepare activation key map
      ansible.builtin.set_fact:
        _ak_map: "{{ dict((activation_keys.split(',') | map('split',':') | list)) }}"

    - name: Build enhanced %post section
      ansible.builtin.set_fact:
        _post_section: "{{ lookup('template', playbook_dir + '/templates/kickstart_post_section.j2') }}"

    - name: Backup existing target file if present
      ansible.builtin.stat:
        path: "{{ sat_new_template_path }}"
      register: _new_stat

    - name: Create backup of existing target template
      ansible.builtin.copy:
        src: "{{ sat_new_template_path }}"
        dest: "{{ sat_new_template_path }}.bak_{{ _timestamp }}"
        remote_src: true
      when: _new_stat.stat.exists

    - name: Assemble new template content (header + post)
      ansible.builtin.set_fact:
        _new_template_content: |
          <%# Enhanced Kickstart Post Template generated {{ ansible_date_time.iso8601 }} %>
          <%# Source: {{ sat_existing_template_path }} %>
          <%# NOTE: Public SSH keys aggregated from: {{ ssh_key_source_dirs | join(', ') }} %>
          {{ _base_template_content.split('%post')[0] | trim }}
          {{ _post_section }}

    - name: Write new template file
      ansible.builtin.copy:
        content: "{{ _new_template_content }}"
        dest: "{{ sat_new_template_path }}"
        owner: root
        group: root
        mode: '0644'

    - name: Final summary
      ansible.builtin.debug:
        msg: |
          New post kickstart template deployed.
          Path: {{ sat_new_template_path }}
          Base template: {{ sat_existing_template_path }}
          Admin user: {{ admin_user }}
          Activation keys mapping: {{ activation_keys }}
          Public keys injected count: {{ _all_public_keys | length }}
          Backup created: {{ 'yes' if _new_stat.stat.exists else 'no (fresh create)' }}
